#+title: neo emacs
#+AUTHOR: vanniuner
# #!define DARKORANGE/LIGHTORANGE/DARKBLUE/LIGHTBLUE/DARKRED/LIGHTRED/DARKGREEN/LIGHTGREEN
# #!includeurl /Users/van/org/org-roam/C4-PlantUML/juststyle.puml
#+HTML_HEAD: <link rel="stylesheet" type="text/css" href="https://emacs-1308440781.cos.ap-chengdu.myqcloud.com/org_css.css"/>
#+HTML_HEAD: <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
#+HTML_HEAD: <script src="https://emacs-1308440781.cos.ap-chengdu.myqcloud.com/scroll.js"></script>
#+HTML_HEAD: <a href="https://github.com/vanniuner/neo-emacs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70B7FD; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

#+OPTIONS: prop:nil timestamp:t \n:t ^:nil f:t toc:t author:t num:t H:2
#+LATEX_COMPILER: xelatex
#+LATEX_CLASS: elegantpaper
#+MACRO: htmlred @@html:<font color="red"></font>@@
#+MACRO: latexred @@latex:{\color{red}@@@@latex:}@@
#+latex:\newpage


[[file:./image-use.png]]

* About
Neo emacs is a configuration framework for GNU Emacs which is based on doom emacs and focuses on the java web application coding environment. Neo emacs has the following features:
- Code completion: Lsp-java supports maven and gradle project.
- Program debugging: Dap-java supports program debugging.
- Http client: Rest-client is a tool to manually explore and test HTTP REST webservices just like Postman.
- SQL client: Ejc-sql turns Emacs into a simple SQL client which supports various databases.
- Redis client: Eredis Non-blocking Redis client with focus on performance and robustness.
- Terminal emulator: Emacs-libvterm (vterm) is fully-fledged terminal emulator inside GNU Emacs based on libvterm.
- Knowledge management system: Org-roam borrows principles from the Zettelkasten method, providing a solution for non-hierarchical note-taking.
- [[http://1.117.167.195/doc/neo-emacs.html][onlinedoc]]

* How to install
** Install emacs
There have many emacs distribution,just choose one and install it.
- [[https://www.gnu.org/software/emacs/][gnu-emacs]] is the official emacs client.
- [[https://github.com/d12frosted/homebrew-emacs-plus][emacs-plus]] which I used for a long time.
- Building Emacs form source

  building emacs with with source code
  #+begin_src shell -n
  git clone git://git.savannah.gnu.org/emacs.git
  cd emacs
  git checkout emacs-28
  brew install  libxml2
  make configure
  ./configure --with-native-compilation --with-modern-papirus-icon --with-no-titlebar
  make -j4
  make install
  open nextstep/Emacs.app
  #+end_src
- EmacsPorts

  EmacsPorts is the best choice to run NeoEmcas on macos.
  #+begin_src shell
  brew install emacs-mac --with-natural-title-bar --with-mac-metal
  --with-librsvg --with-starter --with-emacs-big-sur-icon --with-native-comp
  defaults write org.gnu.Emacs TransparentTitleBar DARK
  defaults write org.gnu.Emacs HideDocumentIcon kES
  #+end_src

After emacs installation, set environment variables which names EMACS ,this depends on your emacs exec path.
#+begin_src shell
export EMACS=/Applications/Emacs.app/Contents/MacOS/Emacs,
#+end_src
** Clone project

clone doom-emacs and neo-emacs from github.
#+BEGIN_SRC shell
git clone --depth 1 https://github.com/doomemacs/doomemacs ~/.emacs.d
git clone --depth 1 https://github.com/vanniuner/neo-emacs.git ~/.doom.d/
#+END_SRC
** Doom Install
Set up a vpn if you need it.

#+BEGIN_SRC shell
export http_proxy="ip:port"
export https_proxy="ip:port"
#+END_SRC

Set your emacs cmd for doom install.

#+BEGIN_SRC shell
export EMACS= $YOUR EMACS CMD PATH$
#+END_SRC

At last run below, this will take few minutes. And it depends on the quality of your network.

#+BEGIN_SRC shell
~/.emacs.doom/bin/doom install
#+END_SRC
* How to update
#+begin_src shell
export EMACS=/Applications/Emacs.app/Contents/MacOS/EMACS-JAVA-IDE
sh ~/.emacs.d/bin/doom upgrade
sh ~/.emacs.d/bin/doom install
sh ~/.emacs.d/bin/doom sync
#+end_src
* Private setting
Changing Private setting config in the config.el ;
kse ~setq~
#+begin_src elisp
(setq fd-exec-path                   "/opt/homebrew/bin/fd"
      rg-exec-path                   "/opt/homebrew/bin/rg")
#+end_src

#+CAPTION: neo-emacs basic setting
| <l>                       | <l>                                     | <l>                     |
| emacs-module-root         | /opt/homebrew/opt/emacs-plus@28/include | emcas module root       |
| rg-exec-path              | "/opt/homebrew/bin/rg"                  | rg            exec path |
| fd-exec-path              | "/opt/homebrew/bin/fd"                  | fd            exec path |
| dot-exec-path             | "/opt/homebrew/bin/dot"                 | dot           exec path |
| pdflatex-exec-path        | "/Library/TeX/texbin/pdflatex"          | pdflatex      exec path |
| node-bin-dir              | "~/node-v16.14.0/bin"                   | node exec path          |
| lsp-java-jdt-download-url | http://1.117.167.195/download           | jdt-server URL          |
| lsp-java-java-path        |                                         | java11        exec path |
| lsp-maven-path            | "~/.m2/settings.xml"                    | maven setting path      |
| org-directory             | "~/org/"                                | org           root path |
| org-roam-directory        | "~/org/org-roam"                        | org roam      root path |
| display-line-numbers-type | nil                                     | show line number        |
| rime-user-data-dir        | "~/Library/Rime/"                       | rime config input       |
| rime-librime-root         | "~/.doom.d/myconfig/rime-macos/dist"    | emacs-rime/blob/master/ |

* Neoemacs modules
** Java module
- generate .project & .classpath files
    #+ATTR_LATEX: :options numbers=left, commentstyle=\color{violet}
  #+BEGIN_SRC shell
  mvn eclipse:clean eclipse:eclipse
  #+END_SRC
- support projectlombok plugin

  There have a default lombok.jar in ~doom-user-dir/neoemacs~ which you could replace by yourself.
  #+begin_src elisp
  (setq  lombok-jar-path (expand-file-name (concat doom-user-dir "neoemacs/lombok.jar")
  #+end_src
- Key binding
 #+CAPTION: java mode key binding
 | <l>     | <l>                                | <l>                             |
 | KEY     | FUNCTION                           | DESCRIPTION                     |
 | SPC c i | find-implementations               | find where sub class definition |
 | SPC c I | lsp-java-open-super-implementation | find where sub class definition |
 | SPC t e | lsp-treemacs-java-deps-list        | find projects referenced libs   |
 | SPC c f | formart buffer/region              | goto type definition            |
 | SPC c a | lsp-execute-code-action            | code action                     |
 | SPC c d | lsp-jump-definition                | jump to where symbol definition |
 | SPC c D | lsp-jump-reference                 | jump to where symbol referenced |
 | SPC c o | lsp-java-organize-imports          | import require package          |
- how to upgrade jdtls

  1. download the lastest jdt-language-server from https://download.eclipse.org/jdtls/milestones
  2. replace file to ~/.emacs.d/.local/etc/lsp/eclipse.jdt.ls
- error about vfork

  1. go back for doom emacs
     git reset --hard c44bc81a05f3758ceaa28921dd9c830b9c571e61
  2. set the sbcl path
    #+begin_src lisp
    (setq inferior-lisp-program "/opt/homebrew/bin//sbcl")
    #+end_src
- jrebel

 If jrebel not hotload with code change?
  1. exec ~mvn clean package~, and restart your project
  2. check project resources/rebel.xml and make sure the code contains in the config
  3. make sure you have activationed jrebel correctly
  #+begin_src java
  curl https://register.jpy.wang/ReRegister/src/main/java/jrebel/JrebelMain.java
    -o tmp.java && java tmp.java && del tmp.java
  #+end_src

  jrebel 2023.2.0
  https://www.jrebel.com/products/jrebel/download/prev-releases
- HotSwarp

 [[http://hotswapagent.org/mydoc_configuration.html][hotswapagent]] ，a relacement of jrebel
  - DCEVM
    1. [[https://github.com/JetBrains/JetBrainsRuntime/releases?page=6][download]]  [[https://ssw.jku.at/dcevm/][dcevm]]
    2. use command run your application ~dcevmjava -jar app.jar~
  - Hotswapagent
    1. download lastest hotswapagent [[https://github.com/HotswapProjects/HotswapAgent/releases][here]]
    2. replace hotswapagent to $DCEVM_HOME/lib/hotswap/hotswap-agent.jar
  - Startup
    1. config
     [[https://github.com/HotswapProjects/HotswapAgent/blob/master/hotswap-agent-core/src/main/resources/hotswap-agent.properties][hotswap-agent.properties]] hotswap-agent.properties place to project's resources directory.
#+begin_src properties
extraClasspath=target/classes;../longda-archetype-dao/target/classes
watchResources=../longda-archetype-dao/src/main/resources
webappDir=
disabledPlugins=Hibernate, Hibernate3JPA, Hibernate3, Jersey1, Jersey2, MyFaces,
Mojarra, Omnifaces, ELResolver, WildFlyELResolver, OsgiEquinox, Owb, Proxy, Weld,
JBossModules, ResteasyRegistry, Deltaspike, GlassFish, Vaadin, Wicket, CxfJAXRS, FreeMarker, Undertow
autoHotswap=true
spring.basePackagePrefix=pkg.
LOGGER=info
#+end_src
    2. add java startup parameters for HotswapAgent
#+begin_src shell
-XX:HotswapAgent=fatjar -Xlog:redefine+class*=info
#+end_src
    3. use $DCEVM_HOME/bin/java run your application
#+begin_src shell
$dcevmjava -jar app.jar
#+end_src
** Dap-java Usage
- Config the debug host and port, add file $usr_private_dir/dap-java-config.el.
- Use `(setq user-private-dir "$usr_private_dir/dap-java-config.el" )` make it effective.
    #+begin_src lisp -n
    (dap-register-debug-template
    "user-service"
    (list :name "Java Attach"
            :type "java"
            :request "attach"
            :projectName "user-service"
            :hostName "127.0.0.1"
            :port 1044))
    #+end_src
- key binding
 | <l> | <l>                     | <l>             |
 | KEY | FUNCTION                | DESCRIPTION     |
 | , n | dap-next                | Breakpoint next |
 | , b | dap-breakpoint-toggle   |                 |
 | , c | dap-continue            |                 |
 | , r | dap-eval-region         |                 |
 | , a | dap-eval-thing-at-point |                 |
 | , d | dap-debug               |                 |
 | , u | dap-ui-repl             |                 |
** Company box customize
- use `M-x all-the-icons-material` for checking icon
- company-icon icon config file: ~/.emacs.d/modules/completion/company/config.el
** Ejc-sql Usage
 - Config your db connection in the $usr_private_dir/db-work.el.
   #+ATTR_LATEX: :options numbers=left, commentstyle=\color{violet}
   #+begin_src lisp
    (use-package ejc-sql
    :commands ejc-sql-mode ejc-connect
    :config
    (setq clomacs-httpd-default-port 18090)
    (ejc-create-connection "connection-name"
            :classpath      "~/.m2/repository/mysql/mysql-connector-java/8.0.17/
                mysql-connector-java-8.0.17.jar"
            :connection-uri "jdbc:mysql://localhost/user?useSSL=false&user=root&password=pwd"
            :separator      "</?\.*>" )
    )
    (provide 'db-work)
   #+end_src
#+latex:\newpage
 - sql file
     #+BEGIN_SRC sql -n

     <SELECT>
     SELECT * FROM TABLE_ORG
     </SELECT>

     <SELECT>
     delimiter ;
     COMMENT ON COLUMN TABLE_ORG.PROJECT_CODE IS '项目编码';
     COMMENT ON COLUMN TABLE_ORG.PERIOD IS '期间';
     </SELECT>
     #+END_SRC
 - key binding
    | <l>     | <l>            | <l>                        |
    | KEY     | FUNCTION       | description                |
    | SPC e c | ejc-connection | choose connection with ivy |
    | C-c C-c | ejc-execute    | execute the sql            |
** Eredis Usage
*** connect setting
*M-x* ielm
#+begin_src lisp
(use-package eredis)
(setq rp (eredis-connect "your redis ip" 6379))
(eredis-auth "pwd" rp)
#+end_src
*** send redis command on org mode
key binding C-c C-c
#+begin_src lisp
;; select database
(eredis-select 1)
;; query center-bpm:flow-list-count
(eredis-get "center-bpm:flow-list-count")
(eredis-org-table-from-keys '("center-bpm:flow-list-count" ))
#+end_src

| Key                        | Value(s) | Type   |
| center-bpm:flow-list-count |        1 | string |
** Bookmark
- the bookmark file location :~/.emacs.d/.local/etc/bookmarks
#+begin_src lisp
    (setq bookmark-default-file "~/org/org-roam/command/doom/config/bookmark")
#+end_src
** Rime Usage
- https://github.com/DogLooksGood/emacs-rime supply this plugin.
- https://github.com/rime/plum for more infomation.
- some rime input method config at .doom.d/myconfig/rime-config.
- 'emacs-module.h' file not found
 #+begin_src shell
  lib.c:23:10: fatal error: 'emacs-module.h' file not found
    #include <emacs-module.h>
            ^~~~~~~~~~~~~~~~
 #+end_src

 #+begin_src shell
cp /opt/homebrew/opt/emacs-plus@29/include/emacs-module.h /Users/van/.doom.d/neoemacs/rime-macos/dist/include
 #+end_src
** Libvterm Usage
- Configuration
  - fish shell configuration
  #+begin_src shell
  function vterm_printf;
      if begin; [  -n "$TMUX" ]  ; and  string match -q -r "screen|tmux" "$TERM"; end
          # tell tmux to pass the escape sequences through
          printf "\ePtmux;\e\e]%s\007\e\\" "$argv"
      else if string match -q -- "screen*" "$TERM"
          # GNU screen (screen, screen-256color, screen-256color-bce)
          printf "\eP\e]%s\007\e\\" "$argv"
      else
          printf "\e]%s\e\\" "$argv"
      end
  end
  if [ "$INSIDE_EMACS" = 'vterm' ]
      function clear
          vterm_printf "51;Evterm-clear-scrollback";
          tput clear;
      end
  end
  #+end_src
- Ubuntu
    #+begin_src shell
    sudo apt install cmake
    sudo apt install libtool-bin
    #+end_src
- MacOs
    #+begin_src shell
    sudo brew install cmake libtool
    #+end_src
- Key Binding
   | <l>     | <l>                  | <l>                                             |
   | KEY     | FUNCTION             | DESCRIPTION                                     |
   | SPC v v | projectile-run-vterm | open vterm window base on the project root path |
   | SPC v p | vterm-send-start     | enable vterm screen roll                        |
   | SPC v s | vterm-send-stop      | disable vterm screen roll                       |
** Elpa Offline
rsync -avz rsync://mirrors.tuna.tsinghua.edu.cn/elpa ~/soft/emacs-elpa
#+begin_src elisp
(setq configuration-layer--elpa-archives
      '(("melpa-cn" . "/soft/emacs-elpa/melpa/")
        ("org-cn"   . "/soft/emacs-elpa/org/")
        ("gnu-cn"   . "/soft/emacs-elpa/gnu/")
        ("marmalade-cn"   . "/soft/emacs-elpa//marmalade/")))
#+end_src
** FZF Config
*** fish config
#+begin_src shell
set -x FZF_DEFAULT_OPTS "--preview-window 'right:57%'
    --preview 'bat --style=numbers --line-range :300 {}'
    --bind ctrl-y:preview-up,ctrl-e:preview-down,ctrl-b:preview
    -page-up,ctrl-f:preview-page-down,ctrl-u:preview-half-page-
    up,ctrl-d:preview-half-page-down,shift-up:preview-top,shift
    -down:preview-bottom,alt-up:half-page-up,
    alt-down:half-page-down"
set -x FZF_DEFAULT_COMMAND  'fd --type f --hidden --follow
    --exclude ".git" .
    ".idea" . ".vscode" . "node_modules" .
    "build" . "target" . "classes" . "out" . "class" .
    "*.svg" . "*.puml" . "*.orgids" . "*.css" . "*.DS_Store" '
#+end_src
*** how to ignore files
- add ~/.fdignore
  #+begin_src txt
    .DS_Store
    .orgids
    *.svg
    *.puml
    *.css
    *.class
    *.attach
    *.~undo-tree~
    crpt
  #+end_src
* Org mode
** Doom org style
A vairty of template about org mode code which one referenced the doom doc style [[http://1.117.167.195/doc/doomorgstyle.html][Preview]]
How to use? [[https://github.com/vanniuner/doom-org-style]]
** Dot sketchviz
#+begin_src shell
    cd ~/.doom.d/neoemacs/sketchviz/sketch.js
    npm install --save roughjs
    npm i jsdom
#+end_src

- usage
    #+BEGIN_SRC dotsk :file dotsk-demo.svg
        digraph G {
            bgcolor="transparent"
            rankdir = LR
            a -> b [minlen=2,label="ϟ"]
        }
    #+END_SRC

    #+RESULTS:
    [[file:dotsk-demo.svg]]

** Latex PDF setting
1. install [[https://tug.org/mactex/][mactex]]
2. put [[https://github.com/ElegantLaTeX/ElegantPaper/blob/master/elegantpaper.cls][elegantpaper.cls]] under the org file dir
3. add the code in the head of your org mode file
   #+begin_src org
    #+LATEX_COMPILER: xelatex
    #+LATEX_CLASS: elegantpaper
    #+OPTIONS: prop:t
   #+end_src

4. [[https://www.sheerwill.live/posts/main/20220723211325-vanilla_emacs_with_purcell/][more info]]
* Alfred
Alfred repeat item
perference -> Advanced -> Rebuild macOS Metadata.
alfred -> reload
* Questions
** install ffmpeg
- brew install ffmpeg
** how to install all-the-icons?
- M-x install-package all-the-icons
- M-x all-the-icons-install-fonts
** how to install rime ?
- M-x install-package rime
unzip rime-1.5.3-osx.zip -d ~/.emacs.d/librime
** how to install vterm?
#+begin_src bash
cd .emacs.d/.local/straight/build/vterm/
mkdir -p build
# install cmake and libtool-bin
brew install cmake, brew install libtool
mkdir -p build
cd build
cmake ..
make
#+end_src
** lsp-springboot
#+begin_src bash
mvn -Djdt.js.server.root=/Users/van/.emacs.d/.local/etc/.cache/
lsp/eclipse.jdt.ls/server/ -Djunit.runner.root=
/Users/van/.emacs.d/.local/etc/eclipse.jdt.ls/test-runner/
-Djunit.runner.fileName=junit-platform-console-standalone.jar
-Djava.debug.root=/Users/van/.emacs.d/.local/etc/.cache/lsp/
eclipse.jdt.ls/server/bundles clean package
-Djdt.download.url=http://download.eclipse.org/jdtls/snapshots/
jdt-language-server-latest.tar.gz -f lsp-java-server-build.pom
#+end_src
** useful key setting
- Change caps_lock to control if pressed with other keys, to escape if pressed alone.
  [[file:key-change.png]]

** why message showed could not load undo-tree history
#+begin_src shell
brew install watchexec
#+end_src
** File mode specification error: (file-missing Doing vfork No such file or directory)
When open a Java file this error happen.
It's because the environment do not content on your GUI Emacs.
It works well on your termianl environment with start Emacs by Emacs -nw.
So the solution is change the execution file with the below shell script on MacOs
- emacs-plus cp to application dir
#+begin_src shell
    cp -rf /opt/homebrew/opt/emacs-plus@28/Emacs.app/ /Applications/
    mv /Applications/Emacs.app/Contents/MacOS/Emacs Emacs.old
#+end_src
- /Applications/Emacs.app/Contents/MacOS/Emacs
#+begin_src shell
    #!/usr/local/bin/fish
    /Applications/Emacs.app/Contents/MacOS/Emacs.old
#+end_src
** image dir
#+begin_src shell
ln -s ~/org/org-roam/image any_where/image
#+end_src
* About Logo
edit with: [[https://ps.gaoding.com/#/][online-ps-editor]], [[./logo.psd][psd file]]
* Dependencies

https://github.com/hlissner/doom-emacs/blob/master/docs/getting_started.org

[[https://github.com/BurntSushi/ripgrep]]

[[https://github.com/junegunn/fzf]]

[[https://github.com/kostafey/ejc-sql]]

https://leiningen.org/

[[https://plantuml.com/]]

[[https://github.com/emacs-lsp/lsp-java]]

https://projectlombok.org/

https://github.com/DogLooksGood/emacs-rime

[[https://github.com/be5invis/Sarasa-Gothic]]

[[https://github.com/akicho8/string-inflection]]

https://raw.githubusercontent.com/alibaba/p3c/master/p3c-formatter/eclipse-codestyle.xml

https://www.tug.org/mactex/
